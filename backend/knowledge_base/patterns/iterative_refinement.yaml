# Iterative Refinement Pattern
# Loop-based workflow for progressive improvement

metadata:
  pattern_id: "pattern_iteration_001"
  name: "Iterative Refinement"
  description: "Workflow with iteration loop: Start -> LLM -> Iteration -> LLM (refine) -> End. Ideal for progressive refinement, multi-pass processing, quality improvement."
  complexity: "complex"
  node_count: 5
  use_cases:
    - "Iterative text refinement"
    - "Multi-pass translation"
    - "Progressive summarization"
    - "Quality improvement loops"
  tags:
    - "iteration"
    - "loop"
    - "refinement"
    - "complex"

workflow:
  version: "0.1"
  graph:
    nodes:
      - id: "start_1"
        type: "start"
        data:
          title: "Start"
          variables:
            - variable: "initial_text"
              type: "string"
              label: "Initial Text"
              required: true
            - variable: "iterations"
              type: "number"
              label: "Number of Iterations"
              required: true
              default: 3
          desc: "Workflow entry point"
        position:
          x: 100
          y: 100

      - id: "llm_initial"
        type: "llm"
        data:
          title: "Initial Processing"
          model:
            provider: "openai"
            name: "gpt-4"
            mode: "chat"
            completion_params:
              temperature: 0.7
          prompt_template:
            - role: "user"
              text: "Process the following text: {{#start.initial_text#}}"
        position:
          x: 300
          y: 100

      - id: "iteration_1"
        type: "iteration"
        data:
          title: "Refinement Loop"
          iteration_type: "count"
          max_iterations: "{{#start.iterations#}}"
          input_variable:
            - "llm_initial"
            - "text"
        position:
          x: 500
          y: 100

      - id: "llm_refine"
        type: "llm"
        data:
          title: "Refine"
          model:
            provider: "openai"
            name: "gpt-4"
            mode: "chat"
            completion_params:
              temperature: 0.5
          prompt_template:
            - role: "system"
              text: "You are a refinement expert. Improve the given text."
            - role: "user"
              text: "Refine this text: {{#iteration_1.item#}}"
        position:
          x: 500
          y: 200

      - id: "end_1"
        type: "end"
        data:
          title: "End"
          outputs:
            refined_text: "{{#iteration_1.output#}}"
            iterations_completed: "{{#iteration_1.iteration_count#}}"
        position:
          x: 700
          y: 100

    edges:
      - id: "start_1-llm_initial"
        source: "start_1"
        target: "llm_initial"
      - id: "llm_initial-iteration_1"
        source: "llm_initial"
        target: "iteration_1"
      - id: "iteration_1-llm_refine"
        source: "iteration_1"
        target: "llm_refine"
        sourceHandle: "loop"
      - id: "llm_refine-iteration_1"
        source: "llm_refine"
        target: "iteration_1"
        targetHandle: "feedback"
      - id: "iteration_1-end_1"
        source: "iteration_1"
        target: "end_1"
        sourceHandle: "complete"