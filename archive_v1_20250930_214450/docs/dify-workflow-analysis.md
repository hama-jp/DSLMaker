# Dify Workflow Analysis

## 概要
DifyのGitHubリポジトリから抽出したワークフロー関連の情報をまとめたドキュメントです。

## 調査結果

### 1. リポジトリ構造

```
api/core/workflow/
├── entities/          # ドメインモデルと変数ストレージ
├── graph/            # ワークフローグラフ構造とランタイム状態
├── graph_engine/     # ワークフロー実行オーケストレーション
├── nodes/            # ノード実装
├── node_events/      # ノードライフサイクルイベント
├── workflow_entry.py # ワークフロー実行のメインエントリーポイント
├── constants.py      # ワークフロー関連定数
├── enums.py         # 列挙型定義
└── errors.py        # カスタムワークフローエラーハンドリング
```

### 2. 利用可能なノード種類

Difyでは以下のノード種類が実装されています：

#### 基本ノード
- **Start**: ワークフローの開始点
- **End**: ワークフローの終了点
- **Answer**: 応答生成ノード

#### AI/LLMノード
- **LLM**: 言語モデルノード
- **Agent**: エージェントノード

#### データ処理ノード
- **Code**: コード実行ノード
- **Template Transform**: テンプレート変換ノード
- **Parameter Extractor**: パラメータ抽出ノード
- **Variable Aggregator**: 変数集約ノード
- **Variable Assigner**: 変数割り当てノード

#### ナレッジ・情報処理ノード
- **Knowledge Retrieval**: ナレッジ検索ノード
- **Knowledge Index**: ナレッジインデックスノード
- **Document Extractor**: ドキュメント抽出ノード
- **Datasource**: データソースノード

#### 制御フローノード
- **If/Else**: 条件分岐ノード
- **Loop**: ループノード
- **Iteration**: 反復ノード
- **Question Classifier**: 質問分類ノード

#### 外部連携ノード
- **HTTP Request**: HTTP リクエストノード
- **Tool**: ツールノード

#### リスト操作ノード
- **List Operator**: リスト操作ノード

### 3. LLMノードの詳細設定

#### 主要設定項目
- **Prompt Templates**: プロンプトテンプレート
- **Model Settings**: モデル設定
- **Memory Configuration**: メモリ設定
- **Error Handling Strategy**: エラーハンドリング戦略
- **Retry Configuration**: リトライ設定

#### 機能
- 変数補間をサポート
- マルチモーダル入力（テキスト、画像、ファイル）対応
- 会話コンテキストとメモリ管理
- 構造化出力生成
- LLM応答からの推論抽出

#### 主要メソッド
- `_run()`: メイン実行メソッド
- `invoke_llm()`: 言語モデル呼び出し
- `fetch_prompt_messages()`: モデル入力用メッセージ準備
- `_split_reasoning()`: 応答からの推論抽出

### 4. Startノードの詳細

#### 設定項目
- ノードタイプ: "START"
- 実行タイプ: "ROOT"
- エラー戦略設定
- リトライ設定

#### 機能
- ユーザーとシステム入力の収集
- システム変数の設定
- 後続ノードへの変数渡し

### 5. ワークフローアーキテクチャの特徴

#### 設計原則
- レイヤード設計（厳密な依存関係ルール）
- 並列実行サポート
- ノード反復機能
- 条件ロジック
- 外部コマンド制御

#### 実行特徴
- 高度にモジュラー
- プラガブルミドルウェア
- イベント駆動アーキテクチャ
- 柔軟なAIワークフロー管理

### 6. エンティティ構造

```
workflow/entities/
├── agent.py                    # エージェント関連エンティティ
├── graph_init_params.py        # ワークフローグラフ初期化パラメータ
├── graph_runtime_state.py      # ワークフローグラフランタイム状態
├── run_condition.py            # ワークフロー実行条件
├── variable_pool.py            # ワークフロー変数管理
├── workflow_execution.py       # ワークフロー実行追跡
└── workflow_node_execution.py  # 個別ノード実行追跡
```

### 7. ワークフロー機能

#### サポート機能
- 変数とノード間データフロー
- デバッグとプレビュー機能
- ステップバイステップ実行
- 構造化出力生成
- エラーハンドリングメカニズム
- ノードオーケストレーション
- ファイルアップロード

#### 設定オプション
- ワークフローの公開と共有
- 変数インスペクション
- ショートカットキー
- 効率性の向上機能

## 次のステップ

この情報を基に、DSL MakerアプリケーションでDify互換のワークフローDSLを生成できる機能を実装できます。特に以下の要素が重要になります：

1. **ノード定義**: 各ノードタイプの設定項目と制約
2. **データフロー**: ノード間の変数受け渡し仕様
3. **エラーハンドリング**: 堅牢なワークフロー実行のためのエラー処理
4. **バリデーション**: DSL構造の妥当性検証

---

*このドキュメントはDifyのGitHubリポジトリ (https://github.com/langgenius/dify) の調査に基づいています。*
*最終更新: 2025-09-27*